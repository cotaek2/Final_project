<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD config 3.0//EN"
						"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ezen.dteam.mapper.ticketMapper">

	<select id="selectTheater" resultType="TheaterVO">
		SELECT * FROM theater
	</select>
	
	<select id="selectMovie" resultType="CinemaVO">
	<![CDATA[
		SELECT * FROM dflix.cinema WHERE copenDate BETWEEN DATE_SUB(NOW(), INTERVAL 1 MONTH) AND DATE_ADD(NOW(), INTERVAL 2 WEEK) OR crank < 11 ORDER BY crank IS NULL, CAST(crank AS UNSIGNED) ASC
	]]>
	</select>
	
	<select id="selectMovieCode" resultType="CinemaVO">
	<![CDATA[
		SELECT * FROM dflix.cinema WHERE ccode = #{movieCode}
	]]>
	</select>
	
	<select id="selectScreenHall" resultType="ScreenHallVO">
		SELECT theater.*, screenHall.* FROM screenHall INNER JOIN theater ON theater.tno = screenHall.tno WHERE theater.tno = #{tno}
	</select>

	<select id="selectScreen" resultType="ScreenVO" parameterType="screenVO">
		SELECT theater.*, screenHall.*, s.*, c.cno, c.cname
		FROM screenHall
		INNER JOIN theater ON theater.tno = screenHall.tno
		INNER JOIN screen s ON screenHall.shallno = s.shallno
		INNER JOIN cinema c ON c.cno = s.cno
		WHERE theater.tno = #{tno} AND s.sday = #{sday} AND s.cno = #{cno}
		AND CONCAT(s.sday, ' ', s.sstartTime) > (
			SELECT DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i')
		    )
		ORDER BY s.sno
	</select>
	
	<select id="selectScreenSeat" resultType="ScreenSeatVO">
		SELECT *
		FROM screenSeat ss
		INNER JOIN screenHall sh
		ON ss.shallno = sh.shallno
		INNER JOIN screen s
		ON sh.shallno = s.shallno
		INNER JOIN cinema c
		ON c.cno = s.cno
		INNER JOIN theater t
		ON t.tno = sh.tno
		WHERE  t.tno = #{tno} AND s.sday = #{sday} AND s.cno = #{cno} AND s.shallno = #{shallno} AND s.sstartTime = #{sstartTime}
	</select>
	
	<select id="selectCheckSeat" resultType="TicketDetailVO">
	<![CDATA[
		SELECT * FROM ticketDetail td
		INNER JOIN ticket t ON td.ticketno = t.ticketno
		INNER JOIN screenseat ss ON td.sseatno = ss.sseatno
		WHERE td.sseatno = #{sseatno} AND t.mno = #{mno}
	]]>
	</select>
	

	<insert id="reserveTicket" parameterType="map">
	<![CDATA[
	    START TRANSACTION
	    SELECT * FROM ticket WHERE mno = #{mno} FOR UPDATE;
	    INSERT INTO ticket (ticketTime, ticketDelyn, mno) 
	    VALUES (NOW(), 0, #{mno})
	    ON DUPLICATE KEY UPDATE tickettime = NOW()
	    SET @ticketId = LAST_INSERT_ID()
	    INSERT INTO ticketDetail(ticketno, sno, sseatno, ticketDate)
	    VALUES (@ticketId, #{sno}, #{sseatno}, NOW())
	    COMMIT
	]]>
	</insert>
	
	
</mapper>